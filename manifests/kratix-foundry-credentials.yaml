# ExternalSecrets for Kratix Foundry Pipelines
#
# The Kratix Promise pipelines run in kratix-platform-system and need
# access to Foundry credentials. These use the same Bitwarden secrets
# as the foundry-vtt ExternalSecret.

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: foundry-credentials
  namespace: kratix-platform-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-secretsmanager
    kind: ClusterSecretStore
  target:
    name: foundry-credentials
  data:
    - secretKey: password
      remoteRef:
        key: "1d5d6edc-8005-4313-8524-b1f601490707"
    - secretKey: username
      remoteRef:
        key: "419ba4a2-8683-4fbd-811e-b1f60148c9aa"
    - secretKey: adminPassword
      remoteRef:
        key: "d4595a98-1408-4218-a70f-b1f6014de185"
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: foundry-license
  namespace: kratix-platform-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-secretsmanager
    kind: ClusterSecretStore
  target:
    name: foundry-license
  data:
    - secretKey: license-key
      remoteRef:
        key: "66aaa0b2-d962-4608-96c9-b1f6014d5534"
---
# The Kratix pipeline pods run in the RESOURCE's namespace (foundry-vtt),
# not kratix-platform-system. So we need secrets there too.
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: foundry-credentials
  namespace: foundry-vtt
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-secretsmanager
    kind: ClusterSecretStore
  target:
    name: foundry-credentials
  data:
    - secretKey: password
      remoteRef:
        key: "1d5d6edc-8005-4313-8524-b1f601490707"
    - secretKey: username
      remoteRef:
        key: "419ba4a2-8683-4fbd-811e-b1f60148c9aa"
    - secretKey: adminPassword
      remoteRef:
        key: "d4595a98-1408-4218-a70f-b1f6014de185"
---
# The pipeline also needs the license key in foundry-vtt namespace
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: foundry-license
  namespace: foundry-vtt
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-secretsmanager
    kind: ClusterSecretStore
  target:
    name: foundry-license
  data:
    - secretKey: license-key
      remoteRef:
        key: "66aaa0b2-d962-4608-96c9-b1f6014d5534"
